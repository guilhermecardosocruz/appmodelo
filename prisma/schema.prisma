generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

enum EventType {
  PRE_PAGO
  POS_PAGO
  FREE
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  resetTokens        PasswordResetToken[]

  payments           Payment[]
  ledgerEntries      LedgerEntry[]
  withdrawalRequests WithdrawalRequest[]

  tickets            Ticket[]

  /// ➜ eventos criados por este usuário (organizador)
  events             Event[]
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Event {
  id          String   @id @default(cuid())
  name        String
  type        EventType
  description String?
  location    String?
  latitude    Float?
  longitude   Float?
  inviteSlug  String?  @unique
  eventDate   DateTime?

  ticketPrice String?
  paymentLink String?
  salesStart  DateTime?
  salesEnd    DateTime?

  createdAt   DateTime @default(now())

  /// ➜ DONO do evento (organizador)
  /// opcional para não quebrar eventos antigos; novos sempre terão um organizerId
  organizerId String?
  organizer   User?    @relation(fields: [organizerId], references: [id])

  confirmations EventConfirmation[]
  guests        EventGuest[]
  payments      Payment[]
  tickets       Ticket[]
}

model EventConfirmation {
  id        String   @id @default(cuid())
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId   String
  name      String
  createdAt DateTime @default(now())
}

model EventGuest {
  id          String   @id @default(cuid())
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId     String
  name        String
  slug        String   @unique
  createdAt   DateTime @default(now())
  confirmedAt DateTime?

  // ✅ 1 convidado -> 1 ticket (quando vinculado a algum usuário logado)
  ticket      Ticket?  @relation("GuestTicket")
}

model Payment {
  id          String        @id @default(cuid())
  eventId     String
  organizerId String
  amount      Decimal       @db.Decimal(10, 2)
  status      PaymentStatus @default(PENDING)
  mpPaymentId String?
  externalRef String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  event         Event         @relation(fields: [eventId], references: [id])
  organizer     User          @relation(fields: [organizerId], references: [id])
  ledgerEntries LedgerEntry[]
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model LedgerEntry {
  id          String     @id @default(cuid())
  organizerId String
  paymentId   String?
  type        LedgerType
  amount      Decimal    @db.Decimal(10, 2)
  createdAt   DateTime   @default(now())

  organizer User     @relation(fields: [organizerId], references: [id])
  payment   Payment? @relation(fields: [paymentId], references: [id])
}

enum LedgerType {
  CREDIT
  DEBIT
}

model WithdrawalRequest {
  id          String           @id @default(cuid())
  organizerId String
  amount      Decimal          @db.Decimal(10, 2)
  status      WithdrawalStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  processedAt DateTime?

  organizer User @relation(fields: [organizerId], references: [id])
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
}

model Ticket {
  id           String       @id @default(cuid())
  eventId      String
  userId       String
  attendeeName String?
  status       TicketStatus @default(ACTIVE)
  createdAt    DateTime     @default(now())
  checkedInAt  DateTime?

  // ✅ vínculo opcional com EventGuest (1-1)
  guestId      String?      @unique
  guest        EventGuest?  @relation("GuestTicket", fields: [guestId], references: [id], onDelete: SetNull)

  event Event @relation(fields: [eventId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([eventId])
}

enum TicketStatus {
  ACTIVE
  CANCELLED
}
