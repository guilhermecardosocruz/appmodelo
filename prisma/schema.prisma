generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum EventType {
  PRE_PAGO
  POS_PAGO
  FREE
}

model User {
  id           String                @id @default(cuid())
  name         String
  email        String                @unique
  passwordHash String
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  resetTokens        PasswordResetToken[]

  // Relações financeiras
  payments           Payment[]
  ledgerEntries      LedgerEntry[]
  withdrawalRequests WithdrawalRequest[]

  // Ingressos comprados pelo usuário
  tickets            Ticket[]
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Event {
  id             String              @id @default(cuid())
  name           String
  type           EventType
  description    String?             // para eventos free (e outros) descreverem detalhes
  location       String?             // local do evento
  inviteSlug     String?             @unique // usado para gerar link de convite
  eventDate      DateTime?           // data do evento (opcional)

  // CAMPOS ESPECÍFICOS PARA PRÉ-PAGO
  ticketPrice    String?             // valor do ingresso (ex.: "R$ 50,00")
  paymentLink    String?             // link externo de pagamento/checkout
  salesStart     DateTime?           // início das vendas
  salesEnd       DateTime?           // fim das vendas

  createdAt      DateTime            @default(now())

  // confirmações "genéricas" (link aberto)
  confirmations  EventConfirmation[]

  // convidados nomeados com link individual
  guests         EventGuest[]

  payments       Payment[]

  // ingressos gerados para este evento
  tickets        Ticket[]
}

model EventConfirmation {
  id        String   @id @default(cuid())
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId   String
  name      String
  createdAt DateTime @default(now())
}

model EventGuest {
  id          String   @id @default(cuid())
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId     String
  name        String
  slug        String   @unique
  createdAt   DateTime @default(now())
  confirmedAt DateTime?
}

model Payment {
  id             String         @id @default(cuid())
  eventId        String
  organizerId    String
  amount         Decimal        @db.Decimal(10, 2)
  status         PaymentStatus  @default(PENDING)
  mpPaymentId    String?        // ID real do Mercado Pago
  externalRef    String         // Referência enviada ao MP (external_reference)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  event          Event          @relation(fields: [eventId], references: [id])
  organizer      User           @relation(fields: [organizerId], references: [id])
  ledgerEntries  LedgerEntry[]
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model LedgerEntry {
  id           String      @id @default(cuid())
  organizerId  String
  paymentId    String?
  type         LedgerType
  amount       Decimal     @db.Decimal(10, 2)
  createdAt    DateTime    @default(now())

  organizer    User        @relation(fields: [organizerId], references: [id])
  payment      Payment?    @relation(fields: [paymentId], references: [id])
}

enum LedgerType {
  CREDIT   // venda aprovada
  DEBIT    // saque
}

model WithdrawalRequest {
  id           String           @id @default(cuid())
  organizerId  String
  amount       Decimal          @db.Decimal(10, 2)
  status       WithdrawalStatus @default(PENDING)
  createdAt    DateTime         @default(now())
  processedAt  DateTime?

  organizer    User             @relation(fields: [organizerId], references: [id])
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
}

// Ingressos de eventos atrelados a um usuário
model Ticket {
  id        String       @id @default(cuid())
  eventId   String
  userId    String
  status    TicketStatus @default(ACTIVE)
  createdAt DateTime     @default(now())

  event     Event        @relation(fields: [eventId], references: [id])
  user      User         @relation(fields: [userId], references: [id])
}

enum TicketStatus {
  ACTIVE
  CANCELLED
}
