
===== app/api/payments/preferences/route.ts =====
1 import { NextRequest, NextResponse } from "next/server";
2 import { prisma } from "@/lib/prisma";
3 
4 const TOKEN = process.env.MP_ACCESS_TOKEN;
5 
6 export async function POST(req: NextRequest) {
7   if (!TOKEN) {
8     return NextResponse.json(
9       { error: "MP_ACCESS_TOKEN não configurado" },
10       { status: 500 }
11     );
12   }
13 
14   try {
15     const { eventId } = await req.json();
16 
17     if (!eventId || typeof eventId !== "string") {
18       return NextResponse.json(
19         { error: "eventId obrigatório" },
20         { status: 400 }
21       );
22     }
23 
24     const event = await prisma.event.findUnique({
25       where: { id: eventId },
26     });
27 
28     if (!event) {
29       return NextResponse.json(
30         { error: "Evento não encontrado" },
31         { status: 404 }
32       );
33     }
34 
35     const preco = Number((event as any).prepaidPrice ?? 0);
36 
37     if (!preco || Number.isNaN(preco)) {
38       return NextResponse.json(
39         { error: "Preço do evento inválido" },
40         { status: 400 }
41       );
42     }
43 
44     const body = {
45       items: [
46         {
47           id: event.id,
48           title: event.name,
49           quantity: 1,
50           unit_price: preco,
51         },
52       ],
53       back_urls: {
54         success: `${process.env.NEXT_PUBLIC_APP_URL}/convite/${event.id}`,
55         failure: `${process.env.NEXT_PUBLIC_APP_URL}/eventos/${event.id}/pre`,
56       },
57       auto_return: "approved",
58       external_reference: event.id,
59     };
60 
61     const response = await fetch(
62       "https://api.mercadopago.com/checkout/preferences",
63       {
64         method: "POST",
65         headers: {
66           Authorization: `Bearer ${TOKEN}`,
67           "Content-Type": "application/json",
68         },
69         body: JSON.stringify(body),
70       }
71     );
72 
73     if (!response.ok) {
74       const text = await response.text();
75       console.error("Erro Mercado Pago:", text);
76       return NextResponse.json(
77         { error: "Erro ao criar preferência" },
78         { status: 500 }
79       );
80     }
81 
82     const data = await response.json();
83 
84     return NextResponse.json({ preferenceId: data.id });
85   } catch (e) {
86     console.error(e);
87     return NextResponse.json(
88       { error: "Erro interno ao criar preferência" },
89       { status: 500 }
90     );
91   }
92 }

===== components/MercadoPagoProvider.tsx =====
1 "use client";
2 
3 import { initMercadoPago } from "@mercadopago/sdk-react";
4 import { useEffect, ReactNode } from "react";
5 
6 export function MercadoPagoProvider({ children }: { children: ReactNode }) {
7   useEffect(() => {
8     const key = process.env.NEXT_PUBLIC_MP_PUBLIC_KEY;
9     initMercadoPago(key!, { locale: "pt-BR" });
10   }, []);
11 
12   return <>{children}</>;
13 }

===== app/(app)/eventos/[id]/CheckoutClient.tsx =====
1 "use client";
2 
3 import { useEffect, useState } from "react";
4 import { Payment } from "@mercadopago/sdk-react";
5 import { useParams } from "next/navigation";
6 
7 type PreferenceResponse = {
8   preferenceId: string;
9 };
10 
11 export default function CheckoutClient() {
12   const params = useParams() as { id?: string };
13   const eventId = String(params?.id ?? "").trim();
14 
15   const [preferenceId, setPreferenceId] = useState<string | null>(null);
16   const [loading, setLoading] = useState(false);
17   const [errorMsg, setErrorMsg] = useState<string | null>(null);
18 
19   async function loadPreference() {
20     if (!eventId) return;
21     try {
22       setLoading(true);
23       setErrorMsg(null);
24 
25       const res = await fetch("/api/payments/preferences", {
26         method: "POST",
27         headers: {
28           "Content-Type": "application/json",
29         },
30         body: JSON.stringify({ eventId }),
31       });
32 
33       const data: PreferenceResponse & { error?: string } = await res.json();
34 
35       if (!res.ok || !data.preferenceId) {
36         setErrorMsg(data.error ?? "Não foi possível iniciar o pagamento.");
37         return;
38       }
39 
40       setPreferenceId(data.preferenceId);
41     } catch (error) {
42       console.error(error);
43       setErrorMsg("Erro ao conectar com o servidor de pagamento.");
44     } finally {
45       setLoading(false);
46     }
47   }
48 
49   useEffect(() => {
50     loadPreference();
51     // eslint-disable-next-line react-hooks/exhaustive-deps
52   }, [eventId]);
53 
54   if (!eventId) {
55     return <p className="p-4 text-red-500">Evento inválido.</p>;
56   }
57 
58   if (loading && !preferenceId) {
59     return <p className="p-4 text-center">Carregando pagamento...</p>;
60   }
61 
62   if (errorMsg && !preferenceId) {
63     return (
64       <div className="p-4 text-center text-red-600">
65         {errorMsg}
66       </div>
67     );
68   }
69 
70   if (!preferenceId) {
71     return (
72       <div className="p-4 text-center">
73         <button
74           onClick={loadPreference}
75           className="rounded bg-blue-600 px-4 py-2 text-white"
76         >
77           Tentar novamente
78         </button>
79       </div>
80     );
81   }
82 
83   return (
84     <div className="max-w-xl mx-auto p-4">
85       <h1 className="text-xl font-semibold mb-4 text-center">
86         Pagamento
87       </h1>
88 
89       <Payment
90         initialization={{
91           // amount é obrigatório no tipo; o valor real está na preference
92           amount: 0,
93           preferenceId,
94         }}
95         customization={{
96           // paymentMethods é obrigatório no tipo; deixamos vazio por enquanto
97           paymentMethods: {},
98         }}
99         // onSubmit é obrigatório no tipo; usamos um no-op só para satisfazer o contrato
100         onSubmit={async () => {
101           // Aqui depois podemos integrar com backend, salvar logs, etc.
102           return;
103         }}
104       />
105     </div>
106   );
107 }

===== app/(app)/eventos/[id]/pre/page.tsx =====
1 import CheckoutClient from "../CheckoutClient";
2 
3 export default function EventoPrePagoPage() {
4   return <CheckoutClient />;
5 }
