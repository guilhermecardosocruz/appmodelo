
===== app/(app)/convite/[slug]/ConviteClient.tsx =====
1 "use client";
2 
3 import { useEffect, useState } from "react";
4 import { useParams } from "next/navigation";
5 
6 type EventType = "PRE_PAGO" | "POS_PAGO" | "FREE";
7 
8 type Event = {
9   id: string;
10   name: string;
11   type: EventType;
12   description?: string | null;
13   location?: string | null;
14   eventDate?: string | null; // ISO string
15 };
16 
17 type Props = {
18   slug: string;
19 };
20 
21 function formatDate(iso?: string | null) {
22   if (!iso) return null;
23   const d = new Date(iso);
24   if (Number.isNaN(d.getTime())) return null;
25 
26   const dia = String(d.getUTCDate()).padStart(2, "0");
27   const mes = String(d.getUTCMonth() + 1).padStart(2, "0");
28   const ano = d.getUTCFullYear();
29   return `${dia}/${mes}/${ano}`;
30 }
31 
32 export default function ConviteClient({ slug }: Props) {
33   const params = useParams() as { slug?: string };
34   const effectiveSlug = String(params?.slug ?? slug ?? "").trim();
35 
36   const [event, setEvent] = useState<Event | null>(null);
37   const [loadingEvent, setLoadingEvent] = useState(true);
38   const [eventError, setEventError] = useState<string | null>(null);
39 
40   const [name, setName] = useState("");
41   const [confirmedName, setConfirmedName] = useState<string | null>(null);
42   const [formError, setFormError] = useState<string | null>(null);
43   const [confirming, setConfirming] = useState(false);
44 
45   useEffect(() => {
46     let active = true;
47 
48     async function loadEvent() {
49       try {
50         setLoadingEvent(true);
51         setEventError(null);
52         setEvent(null);
53 
54         console.log(
55           "[ConviteClient] slug props:",
56           slug,
57           "params.slug:",
58           params?.slug,
59           "effectiveSlug:",
60           effectiveSlug
61         );
62 
63         if (!effectiveSlug) {
64           setEventError("Código de convite inválido.");
65           return;
66         }
67 
68         const res = await fetch(
69           `/api/events/by-invite/${encodeURIComponent(effectiveSlug)}`
70         );
71 
72         if (!res.ok) {
73           const data = await res.json().catch(() => null);
74           if (!active) return;
75 
76           if (res.status === 404) {
77             setEventError("Nenhum evento encontrado para este convite.");
78           } else {
79             setEventError(
80               data?.error ?? "Erro ao carregar informações do evento."
81             );
82           }
83           return;
84         }
85 
86         const data = (await res.json()) as Event;
87         if (!active) return;
88 
89         setEvent(data);
90       } catch (err) {
91         console.error("[ConviteClient] Erro ao carregar evento:", err);
92         if (!active) return;
93         setEventError("Erro inesperado ao carregar informações do evento.");
94       } finally {
95         if (!active) return;
96         setLoadingEvent(false);
97       }
98     }
99 
100     loadEvent();
101 
102     return () => {
103       active = false;
104     };
105     // eslint-disable-next-line react-hooks/exhaustive-deps
106   }, [effectiveSlug]);
107 
108   async function handleSubmit(e: React.FormEvent) {
109     e.preventDefault();
110 
111     const trimmed = name.trim();
112     if (!trimmed) {
113       setFormError("Por favor, digite seu nome para confirmar a presença.");
114       setConfirmedName(null);
115       return;
116     }
117 
118     if (!event || !event.id) {
119       setFormError(
120         "Ainda não foi possível identificar o evento deste convite. Tente novamente em alguns segundos."
121       );
122       setConfirmedName(null);
123       return;
124     }
125 
126     try {
127       setConfirming(true);
128       setFormError(null);
129 
130       const res = await fetch(`/api/events/${event.id}/confirmados`, {
131         method: "POST",
132         headers: {
133           "Content-Type": "application/json",
134         },
135         body: JSON.stringify({
136           name: trimmed,
137           // se quiser, podemos enviar também o slug aqui no futuro
138         }),
139       });
140 
141       if (!res.ok) {
142         const data = await res.json().catch(() => null);
143         setFormError(
144           data?.error ?? "Erro ao registrar a confirmação de presença."
145         );
146         setConfirmedName(null);
147         return;
148       }
149 
150       setConfirmedName(trimmed);
151     } catch (err) {
152       console.error("[ConviteClient] Erro ao confirmar presença:", err);
153       setFormError(
154         "Erro inesperado ao registrar a confirmação. Tente novamente."
155       );
156       setConfirmedName(null);
157     } finally {
158       setConfirming(false);
159     }
160   }
161 
162   const formattedDate = formatDate(event?.eventDate);
163 
164   return (
165     <div className="min-h-screen bg-slate-950 text-slate-50">
166       <div className="max-w-2xl mx-auto px-4 py-10 flex flex-col gap-8">
167         <header className="space-y-2">
168           <p className="text-[11px] font-semibold uppercase tracking-[0.2em] text-emerald-400">
169             Confirmação de presença
170           </p>
171 
172           <h1 className="text-2xl sm:text-3xl font-semibold text-slate-50">
173             {event?.name ?? "Convite para evento"}
174           </h1>
175 
176           <p className="text-sm text-slate-400 max-w-xl">
177             Confira os detalhes do evento e, em seguida, confirme sua presença
178             preenchendo seu nome logo abaixo.
179           </p>
180         </header>
181 
182         <section className="space-y-3 text-sm">
183           <h2 className="text-sm font-semibold text-slate-200">
184             Detalhes do evento
185           </h2>
186 
187           <div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 space-y-2">
188             {loadingEvent && (
189               <p className="text-xs text-slate-400">
190                 Carregando informações do evento...
191               </p>
192             )}
193 
194             {!loadingEvent && eventError && (
195               <p className="text-xs text-red-400">{eventError}</p>
196             )}
197 
198             {!loadingEvent && !eventError && event && (
199               <div className="space-y-1 text-xs sm:text-sm text-slate-300">
200                 <p>
201                   <span className="font-semibold text-slate-100">Evento:</span>{" "}
202                   {event.name}
203                 </p>
204 
205                 {formattedDate && (
206                   <p>
207                     <span className="font-semibold text-slate-100">Data:</span>{" "}
208                     {formattedDate}
209                   </p>
210                 )}
211 
212                 {event.location && (
213                   <p>
214                     <span className="font-semibold text-slate-100">Local:</span>{" "}
215                     {event.location}
216                   </p>
217                 )}
218 
219                 <p>
220                   <span className="font-semibold text-slate-100">Tipo:</span>{" "}
221                   {event.type === "FREE"
222                     ? "Evento gratuito"
223                     : event.type === "PRE_PAGO"
224                     ? "Evento pré-pago"
225                     : "Evento pós-pago"}
226                 </p>
227 
228                 {event.description && (
229                   <p className="pt-1">
230                     <span className="font-semibold text-slate-100">
231                       Descrição:
232                     </span>{" "}
233                     {event.description}
234                   </p>
235                 )}
236               </div>
237             )}
238 
239             {!loadingEvent && !eventError && !event && (
240               <p className="text-xs text-slate-400">
241                 Não foi possível carregar informações do evento.
242               </p>
243             )}
244           </div>
245         </section>
246 
247         <section className="space-y-3">
248           <h2 className="text-sm font-semibold text-slate-200">
249             Confirmar presença
250           </h2>
251 
252           <form onSubmit={handleSubmit} className="flex flex-col gap-3">
253             <div className="flex flex-col gap-1">
254               <label className="text-xs font-medium text-slate-300">
255                 Seu nome completo
256               </label>
257               <input
258                 type="text"
259                 value={name}
260                 onChange={(e) => setName(e.target.value)}
261                 className="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
262                 placeholder="Digite seu nome para confirmar presença"
263                 disabled={confirming || loadingEvent || !!eventError}
264               />
265             </div>
266 
267             {formError && (
268               <p className="text-[11px] text-red-400">{formError}</p>
269             )}
270 
271             <button
272               type="submit"
273               disabled={confirming || loadingEvent || !!eventError}
274               className="mt-1 inline-flex items-center justify-center rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 disabled:opacity-60"
275             >
276               {confirming ? "Confirmando..." : "Confirmar presença"}
277             </button>
278           </form>
279 
280           {confirmedName && (
281             <div className="mt-2 rounded-lg border border-emerald-700 bg-emerald-900/20 px-3 py-2">
282               <p className="text-xs text-emerald-300">
283                 Presença confirmada para{" "}
284                 <span className="font-semibold">{confirmedName}</span>.
285               </p>
286               <p className="mt-1 text-[10px] text-emerald-200/80">
287                 Esta confirmação já foi registrada na lista de confirmados do
288                 evento.
289               </p>
290             </div>
291           )}
292         </section>
293 
294         <footer className="pt-4 border-t border-slate-900 text-[11px] text-slate-500 flex flex-wrap items-center justify-between gap-2">
295           <span className="break-all">
296             Código do convite:{" "}
297             <span className="text-slate-300">
298               {effectiveSlug || "(não informado)"}
299             </span>
300           </span>
301 
302           {confirmedName && (
303             <span className="text-emerald-300">
304               Obrigado por confirmar sua presença ✨
305             </span>
306           )}
307         </footer>
308       </div>
309     </div>
310   );
311 }

===== app/(app)/convite/pessoa/[slug]/GuestInviteClient.tsx =====
1 "use client";
2 
3 import { useEffect, useState } from "react";
4 import { useParams } from "next/navigation";
5 
6 type EventType = "PRE_PAGO" | "POS_PAGO" | "FREE";
7 
8 type Event = {
9   id: string;
10   name: string;
11   type: EventType;
12   description?: string | null;
13   location?: string | null;
14   eventDate?: string | null;
15 };
16 
17 type Guest = {
18   id: string;
19   name: string;
20   slug: string;
21   confirmedAt?: string | null;
22 };
23 
24 type Props = {
25   slug: string;
26 };
27 
28 function formatDate(iso?: string | null) {
29   if (!iso) return null;
30   const d = new Date(iso);
31   if (Number.isNaN(d.getTime())) return null;
32 
33   const dia = String(d.getUTCDate()).padStart(2, "0");
34   const mes = String(d.getUTCMonth() + 1).padStart(2, "0");
35   const ano = d.getUTCFullYear();
36   return `${dia}/${mes}/${ano}`;
37 }
38 
39 export default function GuestInviteClient({ slug }: Props) {
40   const params = useParams() as { slug?: string };
41   const effectiveSlug = String(params?.slug ?? slug ?? "").trim();
42 
43   const [event, setEvent] = useState<Event | null>(null);
44   const [guest, setGuest] = useState<Guest | null>(null);
45   const [loading, setLoading] = useState(true);
46   const [error, setError] = useState<string | null>(null);
47 
48   const [confirming, setConfirming] = useState(false);
49   const [confirmError, setConfirmError] = useState<string | null>(null);
50   const [confirmSuccess, setConfirmSuccess] = useState<string | null>(null);
51 
52   useEffect(() => {
53     let active = true;
54 
55     async function load() {
56       try {
57         setLoading(true);
58         setError(null);
59         setEvent(null);
60         setGuest(null);
61         setConfirmError(null);
62         setConfirmSuccess(null);
63 
64         if (!effectiveSlug) {
65           setError("Código de convite inválido.");
66           return;
67         }
68 
69         const res = await fetch(
70           `/api/events/guests/${encodeURIComponent(effectiveSlug)}`
71         );
72 
73         if (!res.ok) {
74           const data = await res.json().catch(() => null);
75           if (!active) return;
76 
77           if (res.status === 404) {
78             setError("Nenhum convidado encontrado para este código.");
79           } else {
80             setError(data?.error ?? "Erro ao carregar informações do convite.");
81           }
82           return;
83         }
84 
85         const data = (await res.json()) as {
86           guest: Guest;
87           event: Event;
88         };
89 
90         if (!active) return;
91         setGuest(data.guest);
92         setEvent(data.event);
93 
94         if (data.guest.confirmedAt) {
95           setConfirmSuccess("Sua presença já está confirmada para este evento.");
96         }
97       } catch (err) {
98         console.error("[GuestInviteClient] Erro ao carregar convite:", err);
99         if (!active) return;
100         setError("Erro inesperado ao carregar informações do convite.");
101       } finally {
102         if (!active) return;
103         setLoading(false);
104       }
105     }
106 
107     load();
108 
109     return () => {
110       active = false;
111     };
112     // eslint-disable-next-line react-hooks/exhaustive-deps
113   }, [effectiveSlug]);
114 
115   async function handleConfirm() {
116     if (!guest) return;
117 
118     try {
119       setConfirming(true);
120       setConfirmError(null);
121       setConfirmSuccess(null);
122 
123       const res = await fetch(
124         `/api/events/guests/${encodeURIComponent(guest.slug)}`,
125         {
126           method: "POST",
127         }
128       );
129 
130       if (!res.ok) {
131         const data = await res.json().catch(() => null);
132         setConfirmError(
133           data?.error ?? "Erro ao registrar sua confirmação de presença."
134         );
135         return;
136       }
137 
138       const updated = (await res.json()) as {
139         confirmedAt?: string | null;
140       };
141 
142       setGuest((prev) =>
143         prev ? { ...prev, confirmedAt: updated.confirmedAt ?? new Date().toISOString() } : prev
144       );
145 
146       setConfirmSuccess("Sua presença foi confirmada com sucesso.");
147     } catch (err) {
148       console.error("[GuestInviteClient] Erro ao confirmar presença:", err);
149       setConfirmError(
150         "Erro inesperado ao registrar a confirmação. Tente novamente."
151       );
152     } finally {
153       setConfirming(false);
154     }
155   }
156 
157   const formattedDate = formatDate(event?.eventDate);
158   const isConfirmed = !!guest?.confirmedAt;
159 
160   return (
161     <div className="min-h-screen bg-slate-950 text-slate-50">
162       <div className="max-w-2xl mx-auto px-4 py-10 flex flex-col gap-8">
163         <header className="space-y-2">
164           <p className="text-[11px] font-semibold uppercase tracking-[0.2em] text-emerald-400">
165             Convite individual
166           </p>
167 
168           <h1 className="text-2xl sm:text-3xl font-semibold text-slate-50">
169             {guest ? `Olá, ${guest.name}` : "Convite para evento"}
170           </h1>
171 
172           <p className="text-sm text-slate-400 max-w-xl">
173             Você recebeu um convite exclusivo para participar deste evento. Veja
174             os detalhes abaixo e confirme sua presença.
175           </p>
176         </header>
177 
178         <section className="space-y-3 text-sm">
179           <h2 className="text-sm font-semibold text-slate-200">
180             Detalhes do evento
181           </h2>
182 
183           <div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 space-y-2">
184             {loading && (
185               <p className="text-xs text-slate-400">
186                 Carregando informações do convite...
187               </p>
188             )}
189 
190             {!loading && error && (
191               <p className="text-xs text-red-400">{error}</p>
192             )}
193 
194             {!loading && !error && event && guest && (
195               <div className="space-y-1 text-xs sm:text-sm text-slate-300">
196                 <p>
197                   <span className="font-semibold text-slate-100">
198                     Convidado:
199                   </span>{" "}
200                   {guest.name}
201                 </p>
202 
203                 <p>
204                   <span className="font-semibold text-slate-100">Evento:</span>{" "}
205                   {event.name}
206                 </p>
207 
208                 {formattedDate && (
209                   <p>
210                     <span className="font-semibold text-slate-100">Data:</span>{" "}
211                     {formattedDate}
212                   </p>
213                 )}
214 
215                 {event.location && (
216                   <p>
217                     <span className="font-semibold text-slate-100">
218                       Local:
219                     </span>{" "}
220                     {event.location}
221                   </p>
222                 )}
223 
224                 <p>
225                   <span className="font-semibold text-slate-100">Tipo:</span>{" "}
226                   {event.type === "FREE"
227                     ? "Evento gratuito"
228                     : event.type === "PRE_PAGO"
229                     ? "Evento pré-pago"
230                     : "Evento pós-pago"}
231                 </p>
232 
233                 {event.description && (
234                   <p className="pt-1">
235                     <span className="font-semibold text-slate-100">
236                       Descrição:
237                     </span>{" "}
238                     {event.description}
239                   </p>
240                 )}
241               </div>
242             )}
243 
244             {!loading && !error && !event && (
245               <p className="text-xs text-slate-400">
246                 Não foi possível carregar informações do evento.
247               </p>
248             )}
249           </div>
250         </section>
251 
252         <section className="space-y-3">
253           <h2 className="text-sm font-semibold text-slate-200">
254             Confirmação de presença
255           </h2>
256 
257           {error && (
258             <p className="text-xs text-red-400">
259               Não é possível confirmar presença: {error}
260             </p>
261           )}
262 
263           {!error && (
264             <>
265               <button
266                 type="button"
267                 disabled={confirming || loading || !guest || isConfirmed}
268                 onClick={handleConfirm}
269                 className="inline-flex items-center justify-center rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 disabled:opacity-60"
270               >
271                 {isConfirmed
272                   ? "Presença já confirmada"
273                   : confirming
274                   ? "Confirmando..."
275                   : "Confirmar presença"}
276               </button>
277 
278               {confirmError && (
279                 <p className="text-[11px] text-red-400">{confirmError}</p>
280               )}
281 
282               {confirmSuccess && (
283                 <div className="mt-2 rounded-lg border border-emerald-700 bg-emerald-900/20 px-3 py-2">
284                   <p className="text-xs text-emerald-300">
285                     {confirmSuccess}
286                   </p>
287                   <p className="mt-1 text-[10px] text-emerald-200/80">
288                     Sua confirmação já foi registrada para o organizador deste
289                     evento.
290                   </p>
291                 </div>
292               )}
293             </>
294           )}
295         </section>
296 
297         <footer className="pt-4 border-t border-slate-900 text-[11px] text-slate-500 flex flex-wrap items-center justify-between gap-2">
298           <span className="break-all">
299             Código do convite:{" "}
300             <span className="text-slate-300">
301               {effectiveSlug || "(não informado)"}
302             </span>
303           </span>
304 
305           {isConfirmed && (
306             <span className="text-emerald-300">
307               Obrigado por confirmar sua presença ✨
308             </span>
309           )}
310         </footer>
311       </div>
312     </div>
313   );
314 }

===== app/api/events/by-invite/[slug]/route.ts =====
1 import { NextRequest, NextResponse } from "next/server";
2 import { prisma } from "@/lib/prisma";
3 
4 export async function GET(_request: NextRequest, context: any) {
5   try {
6     let rawParams = context?.params as any;
7 
8     // Next 16 às vezes passa params como Promise
9     if (rawParams && typeof rawParams.then === "function") {
10       rawParams = await rawParams;
11     }
12 
13     const slug = String(rawParams?.slug ?? "").trim();
14     console.log("[by-invite] slug recebido:", slug);
15 
16     if (!slug) {
17       return NextResponse.json(
18         { error: "Slug do convite é obrigatório." },
19         { status: 400 }
20       );
21     }
22 
23     const [prefix] = slug.split("-");
24 
25     // 1) Tenta pelo inviteSlug exato
26     // 2) Se não achar, tenta por id = slug
27     // 3) Se ainda não achar, tenta por id começando com o prefixo
28     const event = await prisma.event.findFirst({
29       where: {
30         OR: [
31           { inviteSlug: slug },
32           { id: slug },
33           ...(prefix
34             ? [
35                 {
36                   id: {
37                     startsWith: prefix,
38                   },
39                 },
40               ]
41             : []),
42         ],
43       },
44     });
45 
46     console.log("[by-invite] evento encontrado?", !!event);
47 
48     if (!event) {
49       return NextResponse.json(
50         { error: "Nenhum evento encontrado para este convite." },
51         { status: 404 }
52       );
53     }
54 
55     return NextResponse.json(event, { status: 200 });
56   } catch (err) {
57     console.error("[GET /api/events/by-invite/[slug]] Erro:", err);
58     return NextResponse.json(
59       { error: "Erro ao buscar evento pelo convite." },
60       { status: 500 }
61     );
62   }
63 }
