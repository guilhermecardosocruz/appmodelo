
===== components/MercadoPagoProvider.tsx =====
1 "use client";
2 
3 import { initMercadoPago } from "@mercadopago/sdk-react";
4 import { useEffect, ReactNode } from "react";
5 
6 export function MercadoPagoProvider({ children }: { children: ReactNode }) {
7   useEffect(() => {
8     const key = process.env.NEXT_PUBLIC_MP_PUBLIC_KEY;
9     initMercadoPago(key!, { locale: "pt-BR" });
10   }, []);
11 
12   return <>{children}</>;
13 }

===== app/(app)/eventos/[id]/CheckoutClient.tsx =====
1 "use client";
2 
3 import { useEffect, useState } from "react";
4 import { Payment } from "@mercadopago/sdk-react";
5 import { useParams } from "next/navigation";
6 
7 type PreferenceResponse = {
8   preferenceId: string;
9 };
10 
11 export default function CheckoutClient() {
12   const params = useParams() as { id?: string };
13   const eventId = String(params?.id ?? "").trim();
14 
15   const [preferenceId, setPreferenceId] = useState<string | null>(null);
16   const [loading, setLoading] = useState(false);
17   const [errorMsg, setErrorMsg] = useState<string | null>(null);
18 
19   async function loadPreference() {
20     if (!eventId) return;
21     try {
22       setLoading(true);
23       setErrorMsg(null);
24 
25       const res = await fetch("/api/payments/preferences", {
26         method: "POST",
27         headers: {
28           "Content-Type": "application/json",
29         },
30         body: JSON.stringify({ eventId }),
31       });
32 
33       const data: PreferenceResponse & { error?: string } = await res.json();
34 
35       if (!res.ok || !data.preferenceId) {
36         setErrorMsg(data.error ?? "Não foi possível iniciar o pagamento.");
37         return;
38       }
39 
40       setPreferenceId(data.preferenceId);
41     } catch (error) {
42       console.error(error);
43       setErrorMsg("Erro ao conectar com o servidor de pagamento.");
44     } finally {
45       setLoading(false);
46     }
47   }
48 
49   useEffect(() => {
50     loadPreference();
51     // eslint-disable-next-line react-hooks/exhaustive-deps
52   }, [eventId]);
53 
54   if (!eventId) {
55     return <p className="p-4 text-red-500">Evento inválido.</p>;
56   }
57 
58   if (loading && !preferenceId) {
59     return <p className="p-4 text-center">Carregando pagamento...</p>;
60   }
61 
62   if (errorMsg && !preferenceId) {
63     return (
64       <div className="p-4 text-center text-red-600">
65         {errorMsg}
66       </div>
67     );
68   }
69 
70   if (!preferenceId) {
71     return (
72       <div className="p-4 text-center">
73         <button
74           onClick={loadPreference}
75           className="rounded bg-blue-600 px-4 py-2 text-white"
76         >
77           Tentar novamente
78         </button>
79       </div>
80     );
81   }
82 
83   // Drible nos tipos do SDK: usamos o componente tipado como any
84   const PaymentBrick = Payment as any;
85 
86   return (
87     <div className="max-w-xl mx-auto p-4">
88       <h1 className="text-xl font-semibold mb-4 text-center">
89         Pagamento
90       </h1>
91 
92       <PaymentBrick
93         initialization={{
94           // Mercado Pago usa a preference para o valor real
95           preferenceId,
96         }}
97       />
98     </div>
99   );
100 }

===== app/(app)/eventos/[id]/PreEventClient.tsx =====
1 "use client";
2 
3 import { useEffect, useState } from "react";
4 import Link from "next/link";
5 import { useParams } from "next/navigation";
6 
7 type EventType = "PRE_PAGO" | "POS_PAGO" | "FREE";
8 
9 type Event = {
10   id: string;
11   name: string;
12   type: EventType;
13   description?: string | null;
14   location?: string | null;
15   eventDate?: string | null;
16   ticketPrice?: string | null;
17   paymentLink?: string | null;
18   salesStart?: string | null;
19   salesEnd?: string | null;
20   inviteSlug?: string | null;
21 };
22 
23 const APP_URL =
24   process.env.NEXT_PUBLIC_APP_URL && process.env.NEXT_PUBLIC_APP_URL.trim()
25     ? process.env.NEXT_PUBLIC_APP_URL.trim().replace(/\/$/, "")
26     : null;
27 
28 export default function PreEventClient() {
29   const params = useParams() as { id?: string };
30   const eventId = String(params?.id ?? "").trim();
31 
32   const [loading, setLoading] = useState(true);
33   const [saving, setSaving] = useState(false);
34 
35   const [error, setError] = useState<string | null>(null);
36   const [success, setSuccess] = useState<string | null>(null);
37 
38   // Campos do formulário
39   const [name, setName] = useState("");
40   const [eventDate, setEventDate] = useState(""); // "YYYY-MM-DD"
41   const [location, setLocation] = useState("");
42   const [description, setDescription] = useState("");
43   const [ticketPrice, setTicketPrice] = useState("");
44   const [paymentLink, setPaymentLink] = useState("");
45   const [salesStart, setSalesStart] = useState("");
46   const [salesEnd, setSalesEnd] = useState("");
47 
48   useEffect(() => {
49     let active = true;
50 
51     async function load() {
52       try {
53         setLoading(true);
54         setError(null);
55         setSuccess(null);
56 
57         if (!eventId) {
58           setError("Evento não encontrado.");
59           return;
60         }
61 
62         const res = await fetch(`/api/events/${eventId}`);
63         if (!res.ok) {
64           const data = await res.json().catch(() => null);
65           if (!active) return;
66           setError(data?.error ?? "Erro ao carregar evento.");
67           return;
68         }
69 
70         const found = (await res.json()) as Event;
71         if (!active) return;
72 
73         setName(found.name ?? "");
74         setDescription(found.description ?? "");
75         setLocation(found.location ?? "");
76         setTicketPrice(found.ticketPrice ?? "");
77 
78         if (found.eventDate) {
79           setEventDate(found.eventDate.slice(0, 10));
80         } else {
81           setEventDate("");
82         }
83 
84         if (found.salesStart) {
85           setSalesStart(found.salesStart.slice(0, 10));
86         } else {
87           setSalesStart("");
88         }
89 
90         if (found.salesEnd) {
91           setSalesEnd(found.salesEnd.slice(0, 10));
92         } else {
93           setSalesEnd("");
94         }
95 
96         // Monta o link de checkout automaticamente:
97         // prioridade:
98         // 1) paymentLink salvo no banco
99         // 2) se não tiver, usa inviteSlug -> /checkout/[slug]
100         if (found.paymentLink && found.paymentLink.trim()) {
101           setPaymentLink(found.paymentLink.trim());
102         } else if (found.inviteSlug && found.inviteSlug.trim()) {
103           const base =
104             APP_URL ??
105             (typeof window !== "undefined" ? window.location.origin : "");
106           const link = base
107             ? `${base.replace(/\/$/, "")}/checkout/${found.inviteSlug.trim()}`
108             : "";
109           setPaymentLink(link);
110         } else {
111           setPaymentLink("");
112         }
113       } catch (err) {
114         console.error("[PreEventClient] Erro no fetch:", err);
115         if (!active) return;
116         setError("Erro inesperado ao carregar evento.");
117       } finally {
118         if (!active) return;
119         setLoading(false);
120       }
121     }
122 
123     load();
124 
125     return () => {
126       active = false;
127     };
128   }, [eventId]);
129 
130   async function handleSave(e: React.FormEvent) {
131     e.preventDefault();
132     if (!eventId) {
133       setError("Evento não encontrado.");
134       return;
135     }
136 
137     if (!name.trim()) {
138       setError("O nome do evento não pode ficar vazio.");
139       setSuccess(null);
140       return;
141     }
142 
143     try {
144       setSaving(true);
145       setError(null);
146       setSuccess(null);
147 
148       const res = await fetch("/api/events", {
149         method: "PATCH",
150         headers: {
151           "Content-Type": "application/json",
152         },
153         body: JSON.stringify({
154           id: eventId,
155           name: name.trim(),
156           description: description.trim() || null,
157           location: location.trim() || null,
158           ticketPrice: ticketPrice.trim() || null,
159           paymentLink: paymentLink.trim() || null,
160           eventDate: eventDate || null,
161           salesStart: salesStart || null,
162           salesEnd: salesEnd || null,
163         }),
164       });
165 
166       if (!res.ok) {
167         const data = await res.json().catch(() => null);
168         setError(data?.error ?? "Erro ao salvar alterações.");
169         return;
170       }
171 
172       setSuccess("Alterações salvas com sucesso.");
173     } catch (err) {
174       console.error("[PreEventClient] Erro ao salvar:", err);
175       setError("Erro inesperado ao salvar alterações.");
176     } finally {
177       setSaving(false);
178     }
179   }
180 
181   const trimmedLocation = location.trim();
182   const hasLocation = trimmedLocation.length > 0;
183 
184   const googleMapsUrl = hasLocation
185     ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
186         trimmedLocation,
187       )}`
188     : null;
189 
190   const wazeUrl = hasLocation
191     ? `https://waze.com/ul?q=${encodeURIComponent(
192         trimmedLocation,
193       )}&navigate=yes`
194     : null;
195 
196   return (
197     <div className="min-h-screen bg-slate-950 text-slate-50 flex flex-col">
198       <header className="flex items-center justify-between px-6 py-4 border-b border-slate-800">
199         <Link
200           href="/dashboard/"
201           className="text-xs font-medium text-slate-300 hover:text-slate-100"
202         >
203           ← Voltar
204         </Link>
205 
206         <span className="inline-flex items-center rounded-full bg-slate-900 px-3 py-1 text-[11px] font-medium uppercase tracking-wide text-slate-300 border border-slate-700">
207           Evento pré pago
208         </span>
209       </header>
210 
211       <main className="flex-1 px-4 py-6 sm:px-6 lg:px-8 max-w-3xl w-full mx-auto flex flex-col gap-4">
212         {loading && (
213           <p className="text-sm text-slate-300">Carregando evento...</p>
214         )}
215 
216         {!loading && error && (
217           <p className="text-sm text-red-400">{error}</p>
218         )}
219 
220         {!loading && !error && (
221           <form
222             onSubmit={handleSave}
223             className="flex flex-col gap-4 rounded-2xl border border-slate-800 bg-slate-900/70 p-4 sm:p-6"
224           >
225             <h1 className="text-lg sm:text-xl font-semibold text-slate-50">
226               Configurações do evento pré pago
227             </h1>
228 
229             {success && (
230               <p className="text-xs text-emerald-400">
231                 {success}
232               </p>
233             )}
234 
235             {/* Nome */}
236             <div className="flex flex-col gap-1">
237               <label className="text-xs font-medium text-slate-300">
238                 Nome do evento
239               </label>
240               <input
241                 type="text"
242                 value={name}
243                 onChange={(e) => setName(e.target.value)}
244                 className="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
245                 placeholder="Digite o nome do evento"
246               />
247             </div>
248 
249             {/* Data do evento */}
250             <div className="flex flex-col gap-1">
251               <label className="text-xs font-medium text-slate-300">
252                 Data do evento
253               </label>
254               <input
255                 type="date"
256                 value={eventDate}
257                 onChange={(e) => setEventDate(e.target.value)}
258                 className="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
259               />
260               <p className="text-[10px] text-slate-500">
261                 Essa data é salva junto com o evento e pode aparecer nos convites.
262               </p>
263             </div>
264 
265             {/* Período de vendas */}
266             <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
267               <div className="flex flex-col gap-1">
268                 <label className="text-xs font-medium text-slate-300">
269                   Início das vendas
270                 </label>
271                 <input
272                   type="date"
273                   value={salesStart}
274                   onChange={(e) => setSalesStart(e.target.value)}
275                   className="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
276                 />
277                 <p className="text-[10px] text-slate-500">
278                   Data a partir da qual você considera as vendas abertas.
279                 </p>
280               </div>
281 
282               <div className="flex flex-col gap-1">
283                 <label className="text-xs font-medium text-slate-300">
284                   Fim das vendas
285                 </label>
286                 <input
287                   type="date"
288                   value={salesEnd}
289                   onChange={(e) => setSalesEnd(e.target.value)}
290                   className="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
291                 />
292                 <p className="text-[10px] text-slate-500">
293                   Data limite para a compra de ingressos (opcional).
294                 </p>
295               </div>
296             </div>
297 
298             {/* Local do evento */}
299             <div className="flex flex-col gap-1">
300               <label className="text-xs font-medium text-slate-300">
301                 Local do evento
302               </label>
303               <input
304                 type="text"
305                 value={location}
306                 onChange={(e) => setLocation(e.target.value)}
307                 className="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
308                 placeholder="Ex.: Rua Nome da Rua, 123 - Bairro, Cidade - UF"
309               />
310               <p className="text-[10px] text-slate-500">
311                 Formato sugerido: "Rua Nome da Rua, 123 - Bairro, Cidade - UF".
312                 Ex.: "Rua Joaquim Nabuco, 100 - Centro, Criciúma - SC".
313               </p>
314               <p className="text-[10px] text-slate-500">
315                 Esse endereço será usado para gerar atalhos para Google Maps e Waze.
316               </p>
317             </div>
318 
319             {/* Atalhos de mapa (se tiver local) */}
320             {hasLocation && (
321               <div className="flex flex-col gap-2 rounded-xl border border-slate-800 bg-slate-950/60 p-3">
322                 <span className="text-xs font-medium text-slate-300">
323                   Como chegar ao local
324                 </span>
325                 <p className="text-[11px] text-slate-500">
326                   Use os atalhos abaixo para abrir o endereço direto no aplicativo de mapas.
327                 </p>
328 
329                 <div className="flex flex-wrap gap-2 mt-1">
330                   {googleMapsUrl && (
331                     <a
332                       href={googleMapsUrl}
333                       target="_blank"
334                       rel="noopener noreferrer"
335                       className="inline-flex items-center justify-center rounded-lg border border-slate-600 px-3 py-1.5 text-[11px] font-semibold text-slate-100 hover:bg-slate-800/80"
336                     >
337                       Abrir no Google Maps
338                     </a>
339                   )}
340 
341                   {wazeUrl && (
342                     <a
343                       href={wazeUrl}
344                       target="_blank"
345                       rel="noopener noreferrer"
346                       className="inline-flex items-center justify-center rounded-lg border border-slate-600 px-3 py-1.5 text-[11px] font-semibold text-slate-100 hover:bg-slate-800/80"
347                     >
348                       Abrir no Waze
349                     </a>
350                   )}
351                 </div>
352               </div>
353             )}
354 
355             {/* Valor do ingresso */}
356             <div className="flex flex-col gap-1">
357               <label className="text-xs font-medium text-slate-300">
358                 Valor do ingresso
359               </label>
360               <input
361                 type="text"
362                 value={ticketPrice}
363                 onChange={(e) => setTicketPrice(e.target.value)}
364                 className="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
365                 placeholder='Ex.: "R$ 50,00" ou "R$ 30,00 meia, R$ 60,00 inteira"'
366               />
367               <p className="text-[10px] text-slate-500">
368                 Campo livre para você descrever valores (inteira, meia, lotes, etc).
369               </p>
370             </div>
371 
372             {/* Link de pagamento */}
373             <div className="flex flex-col gap-1">
374               <label className="text-xs font-medium text-slate-300">
375                 Link para pagamento / checkout
376               </label>
377               <input
378                 type="url"
379                 value={paymentLink}
380                 readOnly
381                 className="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
382                 placeholder="O link será gerado automaticamente a partir do código de convite."
383               />
384               <p className="text-[10px] text-slate-500">
385                 Copie esse link e envie aos convidados para realizarem o checkout
386                 do ingresso.
387               </p>
388               {paymentLink && (
389                 <p className="text-[10px] text-emerald-400 break-all">
390                   {paymentLink}
391                 </p>
392               )}
393             </div>
394 
395             {/* Descrição */}
396             <div className="flex flex-col gap-1">
397               <label className="text-xs font-medium text-slate-300">
398                 Descrição do evento
399               </label>
400               <textarea
401                 value={description}
402                 onChange={(e) => setDescription(e.target.value)}
403                 rows={4}
404                 className="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500 resize-y"
405                 placeholder="Detalhe regras de pagamento, política de reembolso, lotes, etc."
406               />
407             </div>
408 
409             <div className="flex justify-end">
410               <button
411                 type="submit"
412                 disabled={saving}
413                 className="inline-flex items-center justify-center rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 disabled:opacity-60"
414               >
415                 {saving ? "Salvando..." : "Salvar alterações"}
416               </button>
417             </div>
418           </form>
419         )}
420       </main>
421     </div>
422   );
423 }

===== app/(app)/checkout/[slug]/page.tsx =====
1 import CheckoutClient from "./CheckoutClient";
2 
3 export default function CheckoutPage({ params }: { params: { slug: string } }) {
4   return <CheckoutClient slug={params.slug} />;
5 }

===== app/(app)/checkout/[slug]/CheckoutClient.tsx =====
1 "use client";
2 
3 import { useEffect, useState } from "react";
4 import { Payment } from "@mercadopago/sdk-react";
5 
6 type EventType = "PRE_PAGO" | "POS_PAGO" | "FREE";
7 
8 type Event = {
9   id: string;
10   name: string;
11   type: EventType;
12   description?: string | null;
13   location?: string | null;
14   eventDate?: string | null;
15 };
16 
17 type Props = {
18   slug: string;
19 };
20 
21 type PreferenceResponse = {
22   preferenceId?: string;
23   error?: string;
24 };
25 
26 function formatDate(iso?: string | null) {
27   if (!iso) return null;
28   const d = new Date(iso);
29   if (Number.isNaN(d.getTime())) return null;
30 
31   const dia = String(d.getUTCDate()).padStart(2, "0");
32   const mes = String(d.getUTCMonth() + 1).padStart(2, "0");
33   const ano = d.getUTCFullYear();
34   return `${dia}/${mes}/${ano}`;
35 }
36 
37 export default function CheckoutClient({ slug }: Props) {
38   const effectiveSlug = String(slug ?? "").trim();
39 
40   const [event, setEvent] = useState<Event | null>(null);
41   const [loadingEvent, setLoadingEvent] = useState(true);
42   const [eventError, setEventError] = useState<string | null>(null);
43 
44   const [preferenceId, setPreferenceId] = useState<string | null>(null);
45   const [loadingPreference, setLoadingPreference] = useState(false);
46   const [preferenceError, setPreferenceError] = useState<string | null>(null);
47 
48   useEffect(() => {
49     let active = true;
50 
51     async function loadAll() {
52       try {
53         setLoadingEvent(true);
54         setEventError(null);
55         setEvent(null);
56 
57         setPreferenceId(null);
58         setPreferenceError(null);
59         setLoadingPreference(false);
60 
61         if (!effectiveSlug) {
62           setEventError("Link de checkout inválido.");
63           return;
64         }
65 
66         // 1) Busca o evento pelo slug (inviteSlug)
67         const res = await fetch(
68           `/api/events/by-invite/${encodeURIComponent(effectiveSlug)}`
69         );
70 
71         if (!res.ok) {
72           const data = await res.json().catch(() => null);
73           if (!active) return;
74 
75           if (res.status === 404) {
76             setEventError("Nenhum evento encontrado para este link de checkout.");
77           } else {
78             setEventError(
79               data?.error ?? "Erro ao carregar informações do evento."
80             );
81           }
82           return;
83         }
84 
85         const data = (await res.json()) as Event;
86         if (!active) return;
87         setEvent(data);
88 
89         // 2) Se for pré-pago, cria a preferência de pagamento
90         if (data.type === "PRE_PAGO") {
91           setLoadingPreference(true);
92 
93           const prefRes = await fetch("/api/payments/preferences", {
94             method: "POST",
95             headers: {
96               "Content-Type": "application/json",
97             },
98             body: JSON.stringify({ eventId: data.id }),
99           });
100 
101           const prefJson: PreferenceResponse = await prefRes
102             .json()
103             .catch(() => ({} as PreferenceResponse));
104 
105           if (!active) return;
106 
107           if (!prefRes.ok || !prefJson.preferenceId) {
108             setPreferenceError(
109               prefJson.error ?? "Não foi possível iniciar o pagamento."
110             );
111             return;
112           }
113 
114           setPreferenceId(prefJson.preferenceId);
115         }
116       } catch (err) {
117         console.error("[CheckoutClient] Erro geral no checkout:", err);
118         if (!active) return;
119         setEventError("Erro inesperado ao carregar informações do evento.");
120       } finally {
121         if (!active) return;
122         setLoadingEvent(false);
123         setLoadingPreference(false);
124       }
125     }
126 
127     loadAll();
128 
129     return () => {
130       active = false;
131     };
132   }, [effectiveSlug]);
133 
134   const formattedDate = formatDate(event?.eventDate);
135 
136   return (
137     <div className="min-h-screen bg-slate-950 text-slate-50">
138       <div className="max-w-2xl mx-auto px-4 py-10 flex flex-col gap-8">
139         <header className="space-y-2">
140           <p className="text-[11px] font-semibold uppercase tracking-[0.2em] text-emerald-400">
141             Checkout do evento
142           </p>
143 
144           <h1 className="text-2xl sm:text-3xl font-semibold text-slate-50">
145             {event?.name ?? "Confirmação e pagamento"}
146           </h1>
147 
148           <p className="text-sm text-slate-400 max-w-xl">
149             Confira os detalhes abaixo e finalize o pagamento pelo Mercado Pago.
150           </p>
151         </header>
152 
153         <section className="space-y-3 text-sm">
154           <h2 className="text-sm font-semibold text-slate-200">
155             Detalhes do evento
156           </h2>
157 
158           <div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 space-y-2">
159             {loadingEvent && (
160               <p className="text-xs text-slate-400">
161                 Carregando informações do evento...
162               </p>
163             )}
164 
165             {!loadingEvent && eventError && (
166               <p className="text-xs text-red-400">{eventError}</p>
167             )}
168 
169             {!loadingEvent && !eventError && event && (
170               <div className="space-y-1 text-xs sm:text-sm text-slate-300">
171                 <p>
172                   <span className="font-semibold text-slate-100">Evento:</span>{" "}
173                   {event.name}
174                 </p>
175 
176                 {formattedDate && (
177                   <p>
178                     <span className="font-semibold text-slate-100">Data:</span>{" "}
179                     {formattedDate}
180                   </p>
181                 )}
182 
183                 {event.location && (
184                   <p>
185                     <span className="font-semibold text-slate-100">Local:</span>{" "}
186                     {event.location}
187                   </p>
188                 )}
189 
190                 <p>
191                   <span className="font-semibold text-slate-100">Tipo:</span>{" "}
192                   {event.type === "PRE_PAGO"
193                     ? "Evento pré-pago"
194                     : event.type === "POS_PAGO"
195                     ? "Evento pós-pago"
196                     : "Evento gratuito"}
197                 </p>
198 
199                 {event.description && (
200                   <p className="pt-1">
201                     <span className="font-semibold text-slate-100">
202                       Descrição:
203                     </span>{" "}
204                     {event.description}
205                   </p>
206                 )}
207               </div>
208             )}
209 
210             {!loadingEvent && !eventError && !event && (
211               <p className="text-xs text-slate-400">
212                 Não foi possível carregar informações do evento.
213               </p>
214             )}
215           </div>
216         </section>
217 
218         <section className="space-y-3">
219           <h2 className="text-sm font-semibold text-slate-200">
220             Pagamento
221           </h2>
222 
223           {event && event.type !== "PRE_PAGO" && (
224             <p className="text-xs text-slate-400">
225               Este checkout é pensado para eventos pré pagos. O tipo atual do
226               evento é:{" "}
227               <span className="font-semibold text-slate-100">
228                 {event.type === "POS_PAGO"
229                   ? "Pós-pago"
230                   : event.type === "FREE"
231                   ? "Gratuito"
232                   : event.type}
233               </span>
234               .
235             </p>
236           )}
237 
238           {event && event.type === "PRE_PAGO" && (
239             <div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
240               {loadingPreference && !preferenceId && (
241                 <p className="text-xs text-slate-400">
242                   Preparando pagamento com o Mercado Pago...
243                 </p>
244               )}
245 
246               {preferenceError && (
247                 <p className="text-xs text-red-400">{preferenceError}</p>
248               )}
249 
250               {!loadingPreference && !preferenceError && !preferenceId && (
251                 <p className="text-xs text-slate-400">
252                   Não foi possível iniciar o pagamento. Tente atualizar a página
253                   em alguns instantes.
254                 </p>
255               )}
256 
257               {preferenceId && (
258                 <div className="mt-2 rounded-xl bg-slate-950 p-3">
259                   {/* 
260                     Usamos "as any" aqui para não brigar com os tipos da SDK.
261                     O comportamento real do componente continua o mesmo.
262                   */}
263                   <Payment
264                     {...({
265                       initialization: {
266                         amount: 0, // valor real vem da preference no backend
267                         preferenceId,
268                       },
269                       customization: {
270                         paymentMethods: {},
271                       },
272                       onSubmit: async () => {
273                         // Aqui no futuro podemos registrar logs ou redirecionar
274                         return;
275                       },
276                     } as any)}
277                   />
278                 </div>
279               )}
280             </div>
281           )}
282         </section>
283 
284         <footer className="pt-4 border-t border-slate-900 text-[11px] text-slate-500 flex flex-wrap items-center justify-between gap-2">
285           <span className="break-all">
286             Código do checkout:{" "}
287             <span className="text-slate-300">
288               {effectiveSlug || "(não informado)"}
289             </span>
290           </span>
291         </footer>
292       </div>
293     </div>
294   );
295 }

===== app/api/events/by-invite/[slug]/route.ts =====
1 import { NextRequest, NextResponse } from "next/server";
2 import { prisma } from "@/lib/prisma";
3 
4 export async function GET(_request: NextRequest, context: any) {
5   try {
6     let rawParams = context?.params as any;
7 
8     // Next 16 às vezes passa params como Promise
9     if (rawParams && typeof rawParams.then === "function") {
10       rawParams = await rawParams;
11     }
12 
13     const slug = String(rawParams?.slug ?? "").trim();
14     console.log("[by-invite] slug recebido:", slug);
15 
16     if (!slug) {
17       return NextResponse.json(
18         { error: "Slug do convite é obrigatório." },
19         { status: 400 }
20       );
21     }
22 
23     const [prefix] = slug.split("-");
24 
25     // 1) Tenta pelo inviteSlug exato
26     // 2) Se não achar, tenta por id = slug
27     // 3) Se ainda não achar, tenta por id começando com o prefixo
28     const event = await prisma.event.findFirst({
29       where: {
30         OR: [
31           { inviteSlug: slug },
32           { id: slug },
33           ...(prefix
34             ? [
35                 {
36                   id: {
37                     startsWith: prefix,
38                   },
39                 },
40               ]
41             : []),
42         ],
43       },
44     });
45 
46     console.log("[by-invite] evento encontrado?", !!event);
47 
48     if (!event) {
49       return NextResponse.json(
50         { error: "Nenhum evento encontrado para este convite." },
51         { status: 404 }
52       );
53     }
54 
55     return NextResponse.json(event, { status: 200 });
56   } catch (err) {
57     console.error("[GET /api/events/by-invite/[slug]] Erro:", err);
58     return NextResponse.json(
59       { error: "Erro ao buscar evento pelo convite." },
60       { status: 500 }
61     );
62   }
63 }

===== app/api/events/[id]/route.ts =====
1 import { NextRequest, NextResponse } from "next/server";
2 import { prisma } from "@/lib/prisma";
3 
4 export async function GET(_request: NextRequest, context: any) {
5   try {
6     let rawParams = context?.params as any;
7 
8     // Se o Next resolver params como Promise, tratamos isso
9     if (rawParams && typeof rawParams.then === "function") {
10       rawParams = await rawParams;
11     }
12 
13     const id = String(rawParams?.id ?? "").trim();
14     console.log("[GET /api/events/[id]] params:", rawParams, "id:", id);
15 
16     if (!id) {
17       return NextResponse.json(
18         { error: "ID do evento é obrigatório." },
19         { status: 400 }
20       );
21     }
22 
23     const event = await prisma.event.findUnique({
24       where: { id },
25     });
26 
27     if (!event) {
28       return NextResponse.json(
29         { error: "Evento não encontrado." },
30         { status: 404 }
31       );
32     }
33 
34     return NextResponse.json(event, { status: 200 });
35   } catch (err) {
36     console.error("Erro ao buscar evento por ID:", err);
37     return NextResponse.json(
38       { error: "Erro ao buscar evento." },
39       { status: 500 }
40     );
41   }
42 }

===== app/api/payments/preferences/route.ts =====
1 import { NextRequest, NextResponse } from "next/server";
2 import { prisma } from "@/lib/prisma";
3 
4 const TOKEN = process.env.MP_ACCESS_TOKEN;
5 
6 export async function POST(req: NextRequest) {
7   if (!TOKEN) {
8     return NextResponse.json(
9       { error: "MP_ACCESS_TOKEN não configurado" },
10       { status: 500 }
11     );
12   }
13 
14   try {
15     const { eventId } = await req.json();
16 
17     if (!eventId || typeof eventId !== "string") {
18       return NextResponse.json(
19         { error: "eventId obrigatório" },
20         { status: 400 }
21       );
22     }
23 
24     const event = await prisma.event.findUnique({
25       where: { id: eventId },
26     });
27 
28     if (!event) {
29       return NextResponse.json(
30         { error: "Evento não encontrado" },
31         { status: 404 }
32       );
33     }
34 
35     // ⚠️ aqui estava o problema: o campo real é ticketPrice, não prepaidPrice
36     const preco = Number((event as any).ticketPrice ?? 0);
37 
38     if (!preco || Number.isNaN(preco)) {
39       return NextResponse.json(
40         { error: "Preço do evento inválido" },
41         { status: 400 }
42       );
43     }
44 
45     const body = {
46       items: [
47         {
48           id: event.id,
49           title: event.name,
50           quantity: 1,
51           unit_price: preco,
52         },
53       ],
54       back_urls: {
55         success: `${process.env.NEXT_PUBLIC_APP_URL}/convite/${event.id}`,
56         failure: `${process.env.NEXT_PUBLIC_APP_URL}/eventos/${event.id}/pre`,
57       },
58       auto_return: "approved",
59       external_reference: event.id,
60     };
61 
62     const response = await fetch(
63       "https://api.mercadopago.com/checkout/preferences",
64       {
65         method: "POST",
66         headers: {
67           Authorization: `Bearer ${TOKEN}`,
68           "Content-Type": "application/json",
69         },
70         body: JSON.stringify(body),
71       }
72     );
73 
74     if (!response.ok) {
75       const text = await response.text();
76       console.error("Erro Mercado Pago:", text);
77       return NextResponse.json(
78         { error: "Erro ao criar preferência" },
79         { status: 500 }
80       );
81     }
82 
83     const data = await response.json();
84 
85     return NextResponse.json({ preferenceId: data.id });
86   } catch (e) {
87     console.error(e);
88     return NextResponse.json(
89       { error: "Erro interno ao criar preferência" },
90       { status: 500 }
91     );
92   }
93 }
