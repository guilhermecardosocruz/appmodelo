
===== app/(app)/eventos/[id]/FreeEventClient.tsx =====
1 "use client";
2 
3 import { useEffect, useState } from "react";
4 import Link from "next/link";
5 import { useParams } from "next/navigation";
6 
7 type EventType = "PRE_PAGO" | "POS_PAGO" | "FREE";
8 
9 type Event = {
10   id: string;
11   name: string;
12   type: EventType;
13   description?: string | null;
14   location?: string | null;
15   inviteSlug?: string | null;
16   eventDate?: string | null; // ISO string
17   createdAt?: string;
18 };
19 
20 type Guest = {
21   id: string;
22   name: string;
23   slug: string;
24   confirmedAt?: string | null;
25 };
26 
27 export default function FreeEventClient() {
28   const params = useParams() as { id?: string };
29   const eventId = String(params?.id ?? "").trim();
30 
31   const [loading, setLoading] = useState(true);
32   const [saving, setSaving] = useState(false);
33   const [generatingLink, setGeneratingLink] = useState(false);
34 
35   const [error, setError] = useState<string | null>(null);
36   const [success, setSuccess] = useState<string | null>(null);
37 
38   // Campos do formulário
39   const [name, setName] = useState("");
40   const [eventDate, setEventDate] = useState(""); // "YYYY-MM-DD"
41   const [description, setDescription] = useState("");
42   const [location, setLocation] = useState("");
43   const [inviteSlug, setInviteSlug] = useState<string | null>(null);
44 
45   // Lista de convidados
46   const [guests, setGuests] = useState<Guest[]>([]);
47   const [loadingGuests, setLoadingGuests] = useState(false);
48   const [guestError, setGuestError] = useState<string | null>(null);
49   const [newGuestName, setNewGuestName] = useState("");
50   const [addingGuest, setAddingGuest] = useState(false);
51 
52   useEffect(() => {
53     let active = true;
54 
55     async function load() {
56       try {
57         setLoading(true);
58         setError(null);
59         setSuccess(null);
60 
61         if (!eventId) {
62           setError("Evento não encontrado.");
63           return;
64         }
65 
66         // Carrega evento
67         const res = await fetch("/api/events");
68         if (!res.ok) {
69           const data = await res.json().catch(() => null);
70           if (!active) return;
71           setError(data?.error ?? "Erro ao carregar evento.");
72           return;
73         }
74 
75         const all = (await res.json()) as Event[];
76         if (!active) return;
77 
78         const found = all.find((e) => e.id === eventId) ?? null;
79 
80         if (!found) {
81           setError("Evento não encontrado.");
82           return;
83         }
84 
85         setName(found.name ?? "");
86         setDescription(found.description ?? "");
87         setLocation(found.location ?? "");
88         setInviteSlug(found.inviteSlug ?? null);
89 
90         if (found.eventDate) {
91           const onlyDate = found.eventDate.slice(0, 10);
92           setEventDate(onlyDate);
93         } else {
94           setEventDate("");
95         }
96 
97         // Carrega convidados
98         setLoadingGuests(true);
99         setGuestError(null);
100 
101         const guestsRes = await fetch(`/api/events/${eventId}/guests`);
102         if (!guestsRes.ok) {
103           const data = await guestsRes.json().catch(() => null);
104           if (!active) return;
105           setGuestError(
106             data?.error ?? "Erro ao carregar lista de convidados."
107           );
108         } else {
109           const data = (await guestsRes.json()) as { guests?: Guest[] };
110           if (!active) return;
111           setGuests(data.guests ?? []);
112         }
113       } catch (err) {
114         console.error("[FreeEventClient] Erro no fetch:", err);
115         if (!active) return;
116         setError("Erro inesperado ao carregar evento.");
117       } finally {
118         if (!active) return;
119         setLoading(false);
120         setLoadingGuests(false);
121       }
122     }
123 
124     load();
125 
126     return () => {
127       active = false;
128     };
129   }, [eventId]);
130 
131   async function handleSave(e: React.FormEvent) {
132     e.preventDefault();
133     if (!eventId) {
134       setError("Evento não encontrado.");
135       return;
136     }
137 
138     if (!name.trim()) {
139       setError("O nome do evento não pode ficar vazio.");
140       setSuccess(null);
141       return;
142     }
143 
144     try {
145       setSaving(true);
146       setError(null);
147       setSuccess(null);
148 
149       const res = await fetch("/api/events", {
150         method: "PATCH",
151         headers: {
152           "Content-Type": "application/json",
153         },
154         body: JSON.stringify({
155           id: eventId,
156           name: name.trim(),
157           description: description.trim() || null,
158           location: location.trim() || null,
159           eventDate: eventDate || null,
160         }),
161       });
162 
163       if (!res.ok) {
164         const data = await res.json().catch(() => null);
165         setError(data?.error ?? "Erro ao salvar alterações.");
166         return;
167       }
168 
169       setSuccess("Alterações salvas com sucesso.");
170     } catch (err) {
171       console.error("[FreeEventClient] Erro ao salvar:", err);
172       setError("Erro inesperado ao salvar alterações.");
173     } finally {
174       setSaving(false);
175     }
176   }
177 
178   async function handleGenerateInviteLink() {
179     if (!eventId) {
180       setError("Evento não encontrado.");
181       return;
182     }
183 
184     try {
185       setGeneratingLink(true);
186       setError(null);
187       setSuccess(null);
188 
189       const randomPart = Math.random().toString(36).slice(2, 8);
190       const newSlug = `${eventId.slice(0, 6)}-${randomPart}`;
191 
192       const res = await fetch("/api/events", {
193         method: "PATCH",
194         headers: {
195           "Content-Type": "application/json",
196         },
197         body: JSON.stringify({
198           id: eventId,
199           inviteSlug: newSlug,
200         }),
201       });
202 
203       if (!res.ok) {
204         const data = await res.json().catch(() => null);
205         setError(data?.error ?? "Erro ao gerar link de convite.");
206         return;
207       }
208 
209       setInviteSlug(newSlug);
210       setSuccess("Link de convite atualizado com sucesso.");
211     } catch (err) {
212       console.error("[FreeEventClient] Erro ao gerar link:", err);
213       setError("Erro inesperado ao gerar link de convite.");
214     } finally {
215       setGeneratingLink(false);
216     }
217   }
218 
219   async function handleAddGuest(e: React.FormEvent) {
220     e.preventDefault();
221     if (!eventId) {
222       setGuestError("Evento não encontrado.");
223       return;
224     }
225 
226     const trimmed = newGuestName.trim();
227     if (!trimmed) {
228       setGuestError("Digite o nome do convidado antes de adicionar.");
229       return;
230     }
231 
232     try {
233       setAddingGuest(true);
234       setGuestError(null);
235 
236       const res = await fetch(`/api/events/${eventId}/guests`, {
237         method: "POST",
238         headers: {
239           "Content-Type": "application/json",
240         },
241         body: JSON.stringify({ name: trimmed }),
242       });
243 
244       if (!res.ok) {
245         const data = await res.json().catch(() => null);
246         setGuestError(data?.error ?? "Erro ao adicionar convidado.");
247         return;
248       }
249 
250       const created = (await res.json()) as Guest;
251 
252       setGuests((prev) => [...prev, created]);
253       setNewGuestName("");
254     } catch (err) {
255       console.error("[FreeEventClient] Erro ao adicionar convidado:", err);
256       setGuestError("Erro inesperado ao adicionar convidado.");
257     } finally {
258       setAddingGuest(false);
259     }
260   }
261 
262   const invitePath = inviteSlug ? `/convite/${inviteSlug}` : null;
263   const confirmedListPath = eventId ? `/eventos/${eventId}/confirmados` : null;
264 
265   // Ordena convidados por nome
266   const sortedGuests = [...guests].sort((a, b) =>
267     a.name.localeCompare(b.name, "pt-BR", { sensitivity: "base" })
268   );
269 
270   return (
271     <div className="min-h-screen bg-slate-950 text-slate-50 flex flex-col">
272       <header className="flex items-center justify-between px-6 py-4 border-b border-slate-800">
273         <Link
274           href="/dashboard/"
275           className="text-xs font-medium text-slate-300 hover:text-slate-100"
276         >
277           ← Voltar
278         </Link>
279 
280         <span className="inline-flex items-center rounded-full bg-slate-900 px-3 py-1 text-[11px] font-medium uppercase tracking-wide text-slate-300 border border-slate-700">
281           Evento free
282         </span>
283       </header>
284 
285       <main className="flex-1 px-4 py-6 sm:px-6 lg:px-8 max-w-3xl w-full mx-auto flex flex-col gap-4">
286         {loading && (
287           <p className="text-sm text-slate-300">Carregando evento...</p>
288         )}
289 
290         {!loading && error && (
291           <p className="text-sm text-red-400">{error}</p>
292         )}
293 
294         {!loading && !error && (
295           <form
296             onSubmit={handleSave}
297             className="flex flex-col gap-4 rounded-2xl border border-slate-800 bg-slate-900/70 p-4 sm:p-6"
298           >
299             <h1 className="text-lg sm:text-xl font-semibold text-slate-50">
300               Configurações do evento free
301             </h1>
302 
303             {success && (
304               <p className="text-xs text-emerald-400">
305                 {success}
306               </p>
307             )}
308 
309             {/* Nome */}
310             <div className="flex flex-col gap-1">
311               <label className="text-xs font-medium text-slate-300">
312                 Nome do evento
313               </label>
314               <input
315                 type="text"
316                 value={name}
317                 onChange={(e) => setName(e.target.value)}
318                 className="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
319                 placeholder="Digite o nome do evento"
320               />
321             </div>
322 
323             {/* Data do evento */}
324             <div className="flex flex-col gap-1">
325               <label className="text-xs font-medium text-slate-300">
326                 Data do evento
327               </label>
328               <input
329                 type="date"
330                 value={eventDate}
331                 onChange={(e) => setEventDate(e.target.value)}
332                 className="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
333               />
334               <p className="text-[10px] text-slate-500">
335                 Essa data é salva junto com o evento.
336               </p>
337             </div>
338 
339             {/* Descrição */}
340             <div className="flex flex-col gap-1">
341               <label className="text-xs font-medium text-slate-300">
342                 Descrição do evento
343               </label>
344               <textarea
345                 value={description}
346                 onChange={(e) => setDescription(e.target.value)}
347                 rows={4}
348                 className="rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500 resize-y"
349                 placeholder="Descreva brevemente o evento, público alvo, regras, etc."
350               />
351             </div>
352 
353             {/* Link para convite aberto */}
354             <div className="flex flex-col gap-2 rounded-xl border border-slate-800 bg-slate-950/60 p-3">
355               <div className="flex items-center justify-between gap-2">
356                 <span className="text-xs font-medium text-slate-300">
357                   Link de convite aberto
358                 </span>
359 
360                 <button
361                   type="button"
362                   disabled={generatingLink}
363                   onClick={handleGenerateInviteLink}
364                   className="inline-flex items-center justify-center rounded-lg bg-emerald-600 px-3 py-1.5 text-[11px] font-semibold text-white shadow-sm hover:bg-emerald-500 disabled:opacity-60"
365                 >
366                   {generatingLink
367                     ? "Gerando..."
368                     : inviteSlug
369                     ? "Gerar novo link"
370                     : "Gerar link de convite"}
371                 </button>
372               </div>
373 
374               {inviteSlug && invitePath && (
375                 <div className="flex flex-col gap-1">
376                   <Link
377                     href={invitePath}
378                     className="truncate text-xs text-emerald-400 hover:text-emerald-300 underline-offset-2 hover:underline"
379                   >
380                     {invitePath}
381                   </Link>
382                   <p className="text-[10px] text-slate-500">
383                     Esse link abre a tela de confirmação genérica. Qualquer
384                     pessoa com o link pode confirmar presença.
385                   </p>
386                 </div>
387               )}
388 
389               {!inviteSlug && (
390                 <p className="text-[11px] text-slate-500">
391                   Nenhum link gerado ainda. Clique em &quot;Gerar link de
392                   convite&quot; para criar um link único deste evento.
393                 </p>
394               )}
395             </div>
396 
397             {/* Lista de confirmados (link aberto) */}
398             <div className="flex flex-col gap-2 rounded-xl border border-slate-800 bg-slate-950/60 p-3">
399               <div className="flex items-center justify-between gap-2">
400                 <span className="text-xs font-medium text-slate-300">
401                   Lista de confirmados (link aberto)
402                 </span>
403 
404                 {confirmedListPath && (
405                   <Link
406                     href={confirmedListPath}
407                     className="inline-flex items-center justify-center rounded-lg border border-slate-600 px-3 py-1.5 text-[11px] font-semibold text-slate-100 hover:bg-slate-800/80"
408                   >
409                     Ver lista
410                   </Link>
411                 )}
412               </div>
413               <p className="text-[11px] text-slate-400">
414                 Essa lista mostra todas as pessoas que confirmaram presença a
415                 partir do link aberto de convite.
416               </p>
417             </div>
418 
419             {/* Lista de convidados nomeados */}
420             <div className="flex flex-col gap-3 rounded-2xl border border-slate-800 bg-slate-950/80 p-3 sm:p-4">
421               <div className="flex items-center justify-between gap-2">
422                 <h2 className="text-sm font-semibold text-slate-50">
423                   Lista de convidados
424                 </h2>
425                 {loadingGuests && (
426                   <span className="text-[11px] text-slate-400">
427                     Carregando convidados...
428                   </span>
429                 )}
430               </div>
431 
432               {/* Campo para adicionar convidado */}
433               <form
434                 onSubmit={handleAddGuest}
435                 className="flex flex-col sm:flex-row gap-2"
436               >
437                 <input
438                   type="text"
439                   value={newGuestName}
440                   onChange={(e) => setNewGuestName(e.target.value)}
441                   className="flex-1 rounded-lg border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500"
442                   placeholder="Nome do convidado (ex: João Silva)"
443                   disabled={addingGuest}
444                 />
445                 <button
446                   type="submit"
447                   disabled={addingGuest}
448                   className="inline-flex items-center justify-center rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 disabled:opacity-60"
449                 >
450                   {addingGuest ? "Adicionando..." : "Adicionar convidado"}
451                 </button>
452               </form>
453 
454               {/* Mensagens logo abaixo do campo */}
455               {guestError && (
456                 <p className="text-[11px] text-red-400">
457                   {guestError}
458                 </p>
459               )}
460 
461               {!loadingGuests && !sortedGuests.length && !guestError && (
462                 <p className="text-[11px] text-slate-500">
463                   Nenhum convidado adicionado ainda. Comece adicionando nomes
464                   acima para gerar links de convite individuais.
465                 </p>
466               )}
467 
468               {/* Lista em ordem alfabética */}
469               {sortedGuests.length > 0 && (
470                 <div className="mt-1 space-y-2">
471                   <p className="text-[11px] text-slate-400">
472                     Os convidados abaixo estão ordenados por nome. Quem ainda
473                     não confirmou tem um link exclusivo de convite.
474                   </p>
475 
476                   <ul className="divide-y divide-slate-800">
477                     {sortedGuests.map((guest, index) => {
478                       const guestPath = guest.slug
479                         ? `/convite/pessoa/${guest.slug}`
480                         : null;
481                       const isConfirmed = !!guest.confirmedAt;
482 
483                       return (
484                         <li
485                           key={guest.id}
486                           className="py-2 flex flex-col gap-1"
487                         >
488                           <div className="flex items-center justify-between gap-2">
489                             <div className="flex items-center gap-3">
490                               <span className="w-6 text-[11px] text-slate-500">
491                                 #{index + 1}
492                               </span>
493                               <span className="text-sm text-slate-50">
494                                 {guest.name}
495                               </span>
496                             </div>
497                             <span className="text-[11px]">
498                               {isConfirmed ? (
499                                 <span className="text-emerald-400">
500                                   Confirmado
501                                 </span>
502                               ) : (
503                                 <span className="text-slate-400">
504                                   Pendente
505                                 </span>
506                               )}
507                             </span>
508                           </div>
509 
510                           {/* Link só para quem ainda não confirmou */}
511                           {!isConfirmed && guestPath && (
512                             <Link
513                               href={guestPath}
514                               className="text-[11px] text-emerald-400 hover:text-emerald-300 underline-offset-2 hover:underline break-all"
515                             >
516                               {guestPath}
517                             </Link>
518                           )}
519                         </li>
520                       );
521                     })}
522                   </ul>
523                 </div>
524               )}
525             </div>
526 
527             <div className="flex justify-end">
528               <button
529                 type="submit"
530                 disabled={saving}
531                 className="inline-flex items-center justify-center rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 disabled:opacity-60"
532               >
533                 {saving ? "Salvando..." : "Salvar alterações"}
534               </button>
535             </div>
536           </form>
537         )}
538       </main>
539     </div>
540   );
541 }

===== app/(app)/eventos/[id]/free/page.tsx =====
1 import FreeEventClient from "../FreeEventClient";
2 
3 export default function EventoFreePage() {
4   return <FreeEventClient />;
5 }

===== app/api/events/[id]/guests/route.ts =====
1 import { NextRequest, NextResponse } from "next/server";
2 import { prisma } from "@/lib/prisma";
3 
4 type RouteContext =
5   | { params?: { id?: string } }
6   | { params?: Promise<{ id?: string }> };
7 
8 async function getEventIdFromContext(context: RouteContext): Promise<string> {
9   let rawParams: any = (context as any)?.params ?? {};
10   if (rawParams && typeof rawParams.then === "function") {
11     rawParams = await rawParams;
12   }
13   const id = String(rawParams?.id ?? "").trim();
14   return id;
15 }
16 
17 // GET /api/events/[id]/guests
18 export async function GET(_request: NextRequest, context: RouteContext) {
19   try {
20     const id = await getEventIdFromContext(context);
21 
22     if (!id) {
23       return NextResponse.json(
24         { error: "ID do evento é obrigatório." },
25         { status: 400 }
26       );
27     }
28 
29     const guests = await prisma.eventGuest.findMany({
30       where: { eventId: id },
31       orderBy: { createdAt: "asc" },
32     });
33 
34     return NextResponse.json({ guests }, { status: 200 });
35   } catch (err) {
36     console.error("[GET /api/events/[id]/guests] Erro inesperado:", err);
37     return NextResponse.json(
38       { error: "Erro ao carregar lista de convidados." },
39       { status: 500 }
40     );
41   }
42 }
43 
44 // POST /api/events/[id]/guests
45 export async function POST(request: NextRequest, context: RouteContext) {
46   try {
47     const id = await getEventIdFromContext(context);
48 
49     if (!id) {
50       return NextResponse.json(
51         { error: "ID do evento é obrigatório." },
52         { status: 400 }
53       );
54     }
55 
56     const body = await request.json().catch(() => ({}));
57     const name = String(body.name ?? "").trim();
58 
59     if (!name) {
60       return NextResponse.json(
61         { error: "Nome do convidado é obrigatório." },
62         { status: 400 }
63       );
64     }
65 
66     const event = await prisma.event.findUnique({
67       where: { id },
68       select: { id: true },
69     });
70 
71     if (!event) {
72       return NextResponse.json(
73         { error: "Evento não encontrado." },
74         { status: 404 }
75       );
76     }
77 
78     const randomPart = Math.random().toString(36).slice(2, 8);
79     const slug = `${id.slice(0, 6)}-g-${randomPart}`;
80 
81     const guest = await prisma.eventGuest.create({
82       data: {
83         eventId: event.id,
84         name,
85         slug,
86       },
87     });
88 
89     return NextResponse.json(guest, { status: 201 });
90   } catch (err) {
91     console.error("[POST /api/events/[id]/guests] Erro inesperado:", err);
92     return NextResponse.json(
93       { error: "Erro ao adicionar convidado." },
94       { status: 500 }
95     );
96   }
97 }
